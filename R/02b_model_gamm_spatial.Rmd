---
title: "GAMM Model for Mixed + Spatial effects (mgcv)"
output:
  html_document:
    df_print: paged
---

## Setup

```{r}
# --- Setup
if (!require(mgcv)) {
  install.packages("mgcv")
  library(mgcv)
}

# Input/output folder paths
RAW_DATA_DIR <- "../data/raw/"
INTERIM_DATA_DIR <- "../data/interim/"
PROCESSED_DATA_DIR <- "../data/processed/"
```

```{r}
data <- read.csv(file.path(PROCESSED_DATA_DIR, 'final_data_for_modeling.csv'))
print(dim(data))
print(head(data, 3))
```

```{r}
# Create target: average CPB abundance
data$cpb_abundance <- (data$cpba_count + data$cpbl_count) / 2
data$croptype <- ifelse(data$croptype == 43, 1, 0)


# --- Scale numeric predictors
numeric_vars <- c(
  "gdd", "cum_gdd", "wei_intensity", "wei_prop",
  "summer_avg_temp", "summer_avg_percip", "summer_heavy_rainfall_days",
  "summer_hottest_temp","summer_temp_variability", "winter_coldest_temp",
  "winter_extreme_cold_days", "winter_temp_variability",
  "winter_warm_day_count","winter_heavy_rainfall_days",  "spring_frost_free_days"
)

# Scale each numeric variable if it exists in data
for (v in numeric_vars) {
  if (v %in% names(data)) data[[v]] <- scale(data[[v]])
}

data$farm <- as.factor(data$farm)
data$year <- as.factor(data$year)

```

## Fit GAM with Spatial Smoothing

```{r}
gam_model <- gam(cpb_abundance ~ s(lat, lng) + s(year, bs = "re") + s(farm, bs = "re") +
                  gdd + cum_gdd  + wei_intensity + wei_prop + summer_avg_temp + 
                  summer_avg_percip + summer_heavy_rainfall_days + summer_hottest_temp + 
                  winter_coldest_temp + winter_extreme_cold_days + winter_warm_day_count,
                  data = data, family = gaussian())

# Print the model summary and AIC
summary(gam_model)

```

```{r}
cat("AIC:", AIC(gam_model), "\n")

res <- residuals(gam_model)
mse <- mean(res^2)
print(mse)
```
```{r}
# grab the summary table
s  <- summary(gam_model)$p.table
est <- s[, "Estimate"]
se  <- s[, "Std. Error"]

# residual degrees of freedom
df  <- df.residual(gam_model)

# 97.5th‐percentile t‐value
t  <- qt(0.975, df)

# assemble a matrix of CIs
CI_gam  <- data.frame(
  Estimate = est,
  Lower95  = est - t * se,
  Upper95  = est + t * se
)
CI_gam
```
## SI PLOTS: GAM smooths + RE caterpillars (from the mgcv GAM)

```{r}
# Make sure these are loaded
if (!requireNamespace("gratia", quietly = TRUE)) install.packages("gratia")
if (!requireNamespace("patchwork", quietly = TRUE)) install.packages("patchwork")
library(gratia)
library(ggplot2)
library(patchwork)

# (Re)create the three panels (no harm if they already exist)
labs <- gratia::smooths(gam_model)
idx_space <- which(grepl("^s\\(lat,\\s*lng\\)$", labs))
idx_year  <- which(grepl("^s\\(year\\)$", labs))
idx_farm  <- which(grepl("^s\\(farm\\)$", labs))

stopifnot(length(idx_space)==1, length(idx_year)==1, length(idx_farm)==1)

p_space <- gratia::draw(gam_model, select = idx_space, residuals = FALSE) +
  ggtitle("Spatial smooth: s(lat, lng)")
p_year  <- gratia::draw(gam_model, select = idx_year,  residuals = FALSE) +
  ggtitle("Random effect: s(year)")
p_farm  <- gratia::draw(gam_model, select = idx_farm,  residuals = FALSE) +
  ggtitle("Random effect: s(farm)")

# Save the individual panels (already worked for you, but keeping for completeness)
ggsave("../fig/FigS1a_GAM_spatial_smooth.png", p_space, width = 6.5, height = 5.5, dpi = 300)
ggsave("../fig/FigS1b_GAM_RE_year.png",        p_year,  width = 6.0, height = 6.5, dpi = 300)
ggsave("../fig/FigS1c_GAM_RE_farm.png",        p_farm,  width = 6.0, height = 10.0, dpi = 300)

# Use a design so p_space spans the top row; year and farm sit below (two columns)
# Layout (2 cols):
# Row1: C C  (p_space across both columns)
# Row2: A B  (p_year, p_farm)
design <- "
CC
AB
"

figS1_combined <- patchwork::wrap_plots(
  A = p_year,
  B = p_farm,
  C = p_space,
  design = design,
  guides = "collect"
)

ggsave("../fig/FigS1_GAM_smooths_combined.png", figS1_combined,
       width = 10, height = 10, dpi = 300)
```

